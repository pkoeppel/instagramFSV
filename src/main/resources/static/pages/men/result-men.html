<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Create Instagram pictures</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jquery-jcrop/0.9.15/css/jquery.Jcrop.min.css" rel="stylesheet"/>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-jcrop/0.9.15/js/jquery.Jcrop.min.js"></script>

    <script src="../../js/getData.js" type="text/javascript"></script>
    <script src="../../js/postData.js" type="text/javascript"></script>
    <script src="../../js/deleteData.js" type="text/javascript"></script>
    <script src="../../js/helper.js" type="text/javascript"></script>
    <link href="../../style.css" rel="stylesheet">
</head>
<body>
<div class="topbar">
    <ul>
        <li><a href="../../index.html">Home</a></li>
        <li><a href="matchday-men.html">Spieltag Herren</a></li>
        <li><a>Ergebnis Herren</a></li>
        <li><a href="../youth/matchday-youth.html">Spieltag Kids</a></li>
        <li><a href="../youth/result-youth.html">Ergebnis Kids</a></li>
    </ul>
</div>
<div class="main-page">
    <h1>Instagram-Beitrag erstellen</h1>
    <h2>Ergebnis Herren</h2>
    <br>
    <label for="matches"></label>
    <select id="matches" name="matches">
    </select>
    <input id="deleteEntry" onclick="deleteMatchEntry('men', document.getElementById('matches').value)" type="button"
           value="Eintrag löschen">
    <br>
    <label for="matchResult">Ergebnis:</label>
    <input class="result" id="matchResult" name="matchResult" onkeyup="setCharCount()"
           onblur="addScorerInput(this.value)" type="text">
    <br>
    <label for="headline">Überschrift:</label>
    <input class="resHeadline" id="headline" name="headline" onkeyup="setCharCount()" type="text">
    <br>
    <label for="report">Bericht:</label>
    <br>
    <textarea class="resReport" id="report" name="report" onkeyup="setCharCount()"></textarea>
    <br>
    <label for="future">Ausblick:</label>
    <br>
    <textarea class="resFuture" id="future" name="future" onkeyup="setCharCount()"></textarea>
    <br>
    <p style="margin: 5px" id="chars">Zeichen: 0/2200</p>
    <br>
    <div id="scorer1" class="scorer">
    </div>
    <div id="scorer2" class="scorer">
    </div>
    <br>
    <input accept="image/*" id="inputFile" onchange="newPicture()" type="file">
    <br>
    <div id="showPic"></div>
    <br>
    <input id="saveResized" type="button" value="Bild abspeichern">
    <input id="saveAll" onClick="postPictures()" type="button" value="Bericht absenden">
</div>
<div id="showReport"></div>
<script type="text/javascript">
    window.addEventListener('load', () => {
        getMenMatches();
    });

    function addScorerInput(score) {

        const splitScore = score.split(":");
        for (let team = 1; team <= splitScore.length; team++) {
            const goalNumber = splitScore[team - 1];
            const scorerDiv = document.getElementById('scorer' + team);
            while (scorerDiv.firstChild) {
                scorerDiv.removeChild(scorerDiv.firstChild);
            }
            const header = document.createElement("p");
            header.style.margin = "0px";
            header.style.marginTop = "3px";
            header.innerHTML = "Tore Team " + team + ":";
            scorerDiv.append(header)
            if (goalNumber > 0) {
                for (let goal = 1; goal <= goalNumber; goal++) {
                    const lbMin = document.createElement('label');
                    lbMin.innerHTML = "Min:"
                    scorerDiv.appendChild(lbMin);
                    const goalInputMin = document.createElement('input');
                    goalInputMin.id = "min";
                    goalInputMin.className = "min";
                    goalInputMin.type = "number";
                    scorerDiv.appendChild(goalInputMin);
                    const lbPlayer = document.createElement('label');
                    lbPlayer.innerHTML = "Player:"
                    scorerDiv.appendChild(lbPlayer);
                    const goalInputPlayer = document.createElement('input');
                    goalInputPlayer.id = "player";
                    goalInputPlayer.maxLength = "15";
                    goalInputPlayer.className = "player";
                    goalInputPlayer.type = "text";
                    scorerDiv.appendChild(goalInputPlayer);
                    scorerDiv.appendChild(document.createElement('br'))
                }
            }
        }

    }

    function newPicture() {
        let sp = document.getElementById('showPic');
        while (sp.lastElementChild) {
            sp.removeChild(sp.lastElementChild);
        }

        let image = document.createElement('img');
        image.id = 'crop-image';
        image.src = URL.createObjectURL(event.target.files[0]);
        image.style.display = 'block';
        image.style.maxWidth = '600px';
        image.style.maxHeight = '600px';

        let newW, newH;
        sp.appendChild(image);
        image.onload = function () {
            newW = image.width;
            newH = image.height;
        }

        // noinspection JSUnresolvedReference
        $('#crop-image').Jcrop({
            aspectRatio: 0.8,
            onSelect: function (coOrdinates) {
                coOrdinates.x = coOrdinates.x * (image.naturalWidth / newW);
                coOrdinates.y = coOrdinates.y * (image.naturalHeight / newH);
                coOrdinates.w = coOrdinates.w * (image.naturalWidth / newW);
                coOrdinates.h = coOrdinates.h * (image.naturalHeight / newH);
                document.getElementById('saveResized').onclick = function () {
                    let formData = new FormData();
                    formData.append("coords", JSON.stringify(coOrdinates));
                    formData.append("file", document.getElementById('inputFile').files[0]);
                    fetch(window.location.origin + '/sendMenMatchPicture', {
                        method: 'POST',
                        mode: 'cors',
                        cache: 'no-cache',
                        credentials: 'same-origin',
                        redirect: 'follow',
                        referrerPolicy: 'no-referrer',
                        body: formData,
                    })
                        .then(() => {
                            console.log('Success!');
                            alert("Bild gespeichert!");
                        })
                        .catch((error) => {
                            console.error('Error: ', error);
                            alert("Fehler! Bitte erneut probieren!");
                        });
                }
            }
        });
    }
</script>
</body>
</html>
